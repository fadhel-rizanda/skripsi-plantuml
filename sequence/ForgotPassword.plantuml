@startuml
' === Styling ===
skinparam sequence {
    LifelineFooterStrategy none
    MessageAlign center
    ArrowThickness 1
    ParticipantPadding 20
    GroupBorderThickness 0.5
    GroupBackgroundColor #F9F9F9
}
hide footbox

' === Participants ===
actor Pengguna
participant "Register Page (Next.js FE)" as FE
participant "Change Password Page (Next.js FE)" as CFE
participant "AuthController (Laravel BE)" as BE
participant "Cache (Redis)" as Redis
database "Database (PostgreSQL)" as DB
participant "ResetPasswordNotification (Laravel BE)" as Mailer

' === Registration Flow ===
Pengguna -> FE: Isi form (email)
activate FE
FE -> BE: POST /api/forgot-password/otp { email }
deactivate FE
activate BE

alt Valid input
    BE -> DB: Cek email/username sudah terdaftar?
    activate DB
    DB --> BE: Success (User found)

    BE -> Redis: SET OTP:{email} = generated_code (expired 2 menit)
    activate Redis
    Redis --> BE: OK
    deactivate Redis

    BE -> Mailer: Kirim email berisi kode OTP ke pengguna
    activate Mailer
    Mailer --> BE: OK (Email sent)
    deactivate Mailer
    BE --> FE: 200 OK ("Token sent to email")
    deactivate BE
    activate FE
    FE -> Pengguna: Tampilkan halaman verikasi kode (input kode OTP dan password baru)
    deactivate FE
    deactivate FE

    else Email or username already exists
        DB --> BE: Error (e.g., data not found / connection failure)
        deactivate DB
        activate BE
        BE --> FE: 404 Not Found ("Email not found. Please register first.")
        deactivate BE
        activate FE
        FE -> Pengguna: Tampilkan pesan "Email not found. Please register first."
        deactivate FE
end

' === Account Activation Flow ===
    Pengguna -> CFE: Input kode OTP dari email
    activate CFE
    CFE -> BE: POST /api/forgot-password { otp_code, email, new_password }
    deactivate CFE
    activate BE
    BE -> Redis: GET OTP:{user_id}
    activate Redis
    Redis --> BE: returned_code
    deactivate Redis
        BE -> BE: Cocokkan returned_code dengan otp_code
        activate BE #LightBlue
        deactivate BE #LightBlue
alt OTP tidak cocok atau kadaluarsa
        BE --> CFE: 400 Bad Request ("Invalid or expired OTP")
        activate CFE
        CFE -> Pengguna: Tampilkan pesan error "Invalid or expired OTP. Please try again."
        deactivate CFE
    else OTP valid
    BE -> Redis: DELETE OTP:{user_id}
                    activate Redis
                    Redis --> BE: OK
                    deactivate Redis
        BE -> DB: perbarui data user password=new_password
        deactivate BE

        activate DB
        alt update berhasil
        DB --> BE: Success (User password updated)
                activate BE
                BE --> CFE: 200 OK ("Password updated successfully")
                deactivate
                activate CFE
                CFE -> Pengguna: Tampilkan pesan "Password updated successfully. You can now log in."
                deactivate CFE

        else update gagal
            DB --> BE: Error (e.g., constraint violation / data not found / connection failure)
                deactivate DB
            activate BE
            BE --> CFE: 500 Internal Server Error ("Failed to update password. Please try again later.")
            deactivate BE
            activate CFE
            CFE -> Pengguna: Tampilkan pesan error "Failed to update password. Please try again later."
            deactivate CFE
end
end

@enduml
