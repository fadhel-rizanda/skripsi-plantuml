@startuml
' === Styling ===
skinparam sequence {
    LifelineFooterStrategy none
    MessageAlign center
    ArrowThickness 1
    ParticipantPadding 20
    GroupBorderThickness 0.5
    GroupBackgroundColor #F9F9F9
}
hide footbox

' === Participants ===
actor Admin
actor Pengguna
participant "Communities Page (Next.js FE)" as FE
participant "CommunityController (Laravel BE)" as BE
database "Database (PostgreSQL)" as DB
participant "NotificationService (Laravel BE)" as NS
actor "Pengguna (Admin Komunitas)" as FE_Creator

' === Flow A: Admin Menghapus Komunitas ===
group Admin Menghapus Komunitas
    Admin -> FE: Klik menu "Communities" pada navbar
    activate FE
    FE -> BE: GET /api/communities
    activate BE
    BE -> DB: Ambil daftar seluruh komunitas
    activate DB
    DB --> BE: Return list of communities
    deactivate DB
    BE --> FE: 200 OK (Daftar komunitas)
    deactivate BE
    FE -> Admin: Tampilkan tabel daftar komunitas dengan status terkini
    deactivate FE

    Admin -> FE: Klik tombol "Takedown" pada komunitas tertentu
    activate FE
    FE -> Admin: Tampilkan pop-up konfirmasi penghapusan komunitas
    deactivate FE

    alt Admin konfirmasi "Continue"
        Admin -> FE: Klik "Continue"
        activate FE
        FE -> BE: DELETE /api/communities/{id}
        deactivate FE
        activate BE
        BE -> DB: Hapus data komunitas berdasarkan ID
        deactivate BE
        activate DB

        alt Penghapusan berhasil
            DB --> BE: Success (Row deleted)
            activate BE
             ' Kirim notifikasi ke Creator komunitas
            BE -> NS: Broadcast event "MessageSent" ke channel "notification.{user_id}
            activate NS
            NS -> FE_Creator: Push notification "Your community has been taken down by admin"
            NS --> BE: Event broadcasted
            deactivate NS
            BE --> FE: 200 OK ("Community deleted successfully")
            deactivate BE
            activate FE
            FE -> FE: Perbarui daftar komunitas di UI
            activate FE #LightBlue
            deactivate FE #LightBlue
            FE -> Admin: Tampilkan pesan "Community deleted successfully"
            deactivate FE



        else Gagal menghapus data
            DB --> BE: Error (e.g., data not found / connection failure)
            deactivate DB
            activate BE
            BE --> FE: 500 Internal Server Error ("Failed to delete community")
            deactivate BE
            activate FE
            FE -> Admin: Tampilkan pesan "Failed to delete community. Please try again."
            deactivate FE
        end

    else Admin membatalkan konfirmasi
        Admin -> FE: Klik "Cancel"
        activate FE
        FE -> Admin: Tutup pop-up, data komunitas tetap tersimpan
        deactivate FE
    end
end

|||


' === Flow B: User Menghapus Komunitas ===
group Pengguna Menghapus Komunitas
    Pengguna -> FE: Buka halaman detail komunitas
    activate FE
    FE -> BE: GET /api/communities/{id}
    
    activate BE
    BE -> DB: Ambil detail komunitas berdasarkan ID
    activate DB
    DB --> BE: Return community details
    deactivate DB
    BE --> FE: 200 OK (Community details)
    deactivate BE
    FE -> FE: Cek apakah creator = user saat ini
    activate FE #LightBlue
    deactivate FE #LightBlue
    FE -> Pengguna: Tampilkan detail komunitas (dengan tombol "Takedown" jika creator)
    deactivate FE

    Pengguna -> FE: Klik tombol "Takedown"
    activate FE
    FE -> Pengguna: Tampilkan pop-up konfirmasi penghapusan
    deactivate FE

    alt Pengguna konfirmasi "Continue"
        Pengguna -> FE: Klik "Continue"
        activate FE
        FE -> BE: DELETE /api/communities/{id}
        deactivate FE
        activate BE
        BE -> DB: Hapus data komunitas berdasarkan ID
        deactivate BE
        activate DB

        alt Penghapusan berhasil
            DB --> BE: Success (Row deleted)
            activate BE
            BE --> FE: 200 OK ("Community deleted successfully")
            deactivate BE
            activate FE
            FE -> FE: Redirect ke halaman daftar komunitas
            activate FE #LightBlue
            deactivate FE #LightBlue
            FE -> Pengguna: Tampilkan pesan "Community deleted successfully"
            deactivate FE

        else Gagal menghapus data
            DB --> BE: Error (e.g., data not found / connection failure)
            deactivate DB
            activate BE
            BE --> FE: 500 Internal Server Error ("Failed to delete community")
            deactivate BE
            activate FE
            FE -> Pengguna: Tampilkan pesan "Failed to delete community. Please try again."
            deactivate FE
        end

    else Pengguna membatalkan konfirmasi
        Pengguna -> FE: Klik "Cancel"
        activate FE
        FE -> Pengguna: Tutup pop-up, data komunitas tetap tersimpan
        deactivate FE
    end
end

@enduml