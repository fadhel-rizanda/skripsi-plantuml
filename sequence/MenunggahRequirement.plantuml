@startuml
' === Styling ===
skinparam sequence {
    LifelineFooterStrategy none
    MessageAlign center
    ArrowThickness 1
    ParticipantPadding 20
    GroupBorderThickness 0.5
    GroupBackgroundColor #F9F9F9
}
hide footbox

actor "Calon Pengadopsi" as Adopter
participant "Application Reviewed Page (Next.js FE)" as FE
participant "AttachmentController (Laravel BE)" as BE
participant "Cloud Storage (S3)" as Storage
database "Database(PostgreSQL)" as DB
participant "NotificationSent (Laravel BE)" as Reverb
actor "Penyedia Hewan" as Provider

'== Membuka Halaman Application Reviewed ==
Adopter -> FE: Buka tab "Application Reviewed"
activate FE
FE -> BE: GET /api/adoptions/{id}/requirements
activate BE
BE -> DB: Ambil data requirement dan status
activate DB
DB --> BE: Return list of requirements
deactivate DB
BE --> FE: 200 OK (Data requirement)
deactivate BE
FE -> Adopter: Tampilkan daftar requirement
deactivate FE

'== Mengunggah Dokumen Requirement ==
Adopter -> FE: Tekan tombol "Upload File" dan masukan file terkait
activate FE
FE -> BE: GET /api/attachments/presigned-url
deactivate FE
activate BE

alt Gagal generate URL
    BE --> FE: 500 Internal Server Error ("Failed to generate URL")
    activate FE
    FE -> Adopter: Tampilkan pesan "Failed to prepare upload. Try again."
    deactivate FE
else URL berhasil digenerate
    BE --> FE: 200 OK (Pre-signed URL)
    deactivate BE
    activate FE
    FE -> Storage: POST file ke pre-signed URL
    deactivate FE
    activate Storage

    alt Gagal upload file
        Storage --> FE: 500 Internal Server Error ("Upload failed")
        activate FE
        FE -> Adopter: Tampilkan pesan "Upload failed. Please try again."
        deactivate FE
    else Upload berhasil
        Storage --> FE: 201 Created (File uploaded)
        deactivate Storage
        activate FE

    FE -> BE: POST /api/adoptions/{id}/requirements/{reqId}/upload (Requirement + Metadata data)
    deactivate FE
    activate BE
    BE -> DB: Simpan data upload dan update status "Reviewed"
    deactivate BE
    activate DB
    alt Gagal simpan metadata
        DB --> BE: Error response (e.g., constraint violation / connection failure)
        activate BE
        BE --> FE: 500 Internal Server Error ("Failed to save requirement")
        deactivate BE
        activate FE
        FE -> Adopter: Tampilkan pesan "Upload completed but failed to save. Contact support."
        deactivate FE
    else Penyimpanan metadata berhasil
        DB --> BE: Success (Requirement saved)
        deactivate DB
        activate BE
        BE -> Reverb: Broadcast event "MessageSent" ke channel "chat.{user_id}"
        activate Reverb
        Reverb -> Provider: Push message "New requirement uploaded"
        Reverb --> BE: Event broadcasted
        deactivate Reverb
        BE --> FE: 201 Created (Metadata saved)
        deactivate BE
        activate FE
        FE -> Adopter: Tampilkan pesan "Upload successful"
        deactivate FE
    end
    end
end


'== Notifikasi ke Penyedia Hewan ==
'note right of BE
'    Penyedia hewan dapat melihat
'    requirement baru yang diunggah
'    untuk ditinjau.
'end note

'== Peninjauan oleh Penyedia Hewan ==
Provider -> FE: Buka halaman "Application Reviewed"
activate FE
FE -> BE: GET /api/adoptions/{id}/requirements/review
activate BE
BE -> DB: Ambil data terkait requirement
activate DB
DB --> BE: Return list of requirements
deactivate DB
BE --> FE: 200 OK (Data requirement)
deactivate BE
FE -> Provider: Tampilkan daftar requirement
deactivate FE
'== Menentukan Status Requirement ==
Provider -> FE: Pilih "Accept" atau "Decline"
activate FE
FE -> BE: PUT /api/adoptions/{id}/requirements/{reqId}/accept|decline
deactivate FE
activate BE
BE -> DB: Update status di database
activate DB

alt Gagal update status requirement
    DB --> BE: Error (constraint violation / connection failure)
    BE --> FE: 500 Internal Server Error ("Failed to update status")
    deactivate BE
    activate FE
    FE -> Provider: Tampilkan pesan "Failed to update status. Try again."
    deactivate FE

else Update berhasil
    DB --> BE: Success (Status updated)
    deactivate DB

    alt Status = Accepted
        activate BE
        BE -> Reverb: Broadcast event "MessageSent" ke channel "chat.{user_id}"
        activate Reverb
        Reverb -> Adopter: Push message "Your document has been accepted"
        Reverb --> BE: Event broadcasted
        deactivate Reverb
        BE --> FE: 200 OK ("Requirement accepted successfully")
        deactivate BE
        activate FE
        FE -> Provider: Tampilkan pesan "Requirement accepted successfully"
        deactivate FE

    else Status = Declined
        BE -> Reverb: Broadcast event "MessageSent" ke channel "chat.{user_id}"
        activate BE
        activate Reverb
        Reverb -> Adopter: Push message "Your document has been declined"
        Reverb --> BE: Event broadcasted
        deactivate Reverb
        BE --> FE: 200 OK ("Requirement declined successfully")
        deactivate BE
        activate FE
        FE -> Provider: Tampilkan pesan "Requirement declined successfully"
        deactivate FE
    end
end


@enduml