@startuml
' === Styling ===
skinparam sequence {
    LifelineFooterStrategy none
    MessageAlign center
    ArrowThickness 1
    ParticipantPadding 20
    GroupBorderThickness 0.5
    GroupBackgroundColor #F9F9F9
}
hide footbox

' === Participants ===
actor "Pengguna" as Provider
participant "Next.js FE (Post Page)" as FE
participant "Laravel BE (PostController)" as BE
participant "FileUploadController" as FileBE
participant "Redis Cache" as Redis
participant "Cloud Storage (S3)" as Storage
database "Database" as DB


'== A. Membuka Form Tambah Post ==
group Membuat Post Baru
Provider -> FE: Klik "Create Post"
activate FE
FE -> BE: GET /api/tags
activate BE
BE -> Redis: GET cache:tags
activate Redis

alt Cache tersedia
    Redis --> BE: Return cached tags
else Cache kosong
    Redis --> BE: Cache miss
    deactivate Redis
    BE -> DB: Mengambil semua data tag
    activate DB
    DB --> BE: Return tags data
    deactivate DB
    BE -> Redis: SET cache:tags (expired 1 jam)
    activate Redis
    Redis --> BE: OK
    deactivate Redis
end
BE --> FE: 200 OK (Tags data)
deactivate BE
FE -> FE: Simpan tags di FE state
activate FE #LightBlue
deactivate FE #LightBlue

FE -> Provider: Tampilkan form input data + dropdown tag
deactivate FE


'== B. Penambahan Post ==
alt Ada gambar baru
Provider -> FE: Isi form dan mengunggah gambar baru
activate FE
    FE -> FileBE: GET /api/file-upload/presigned-url
    deactivate FE
    activate FileBE

    alt Gagal generate URL
        FileBE --> FE: 500 Internal Server Error ("Failed to generate URL")
        activate FE
        FE -> Provider: Tampilkan pesan "Failed to generate upload URL"
        deactivate FE
    else URL berhasil digenerate
        FileBE --> FE: 200 OK (Pre-signed URL)
        deactivate FileBE
        activate FE

        FE -> Storage: POST gambar ke pre-signed URL
        deactivate FE
        activate Storage

        alt Gagal upload
            Storage --> FE: 500 Internal Server Error ("Upload failed")
            activate FE
            FE -> Provider: Tampilkan pesan "Failed to upload image"
            deactivate FE
        else Upload berhasil
            Storage --> FE: 201 Created (File uploaded)
            deactivate Storage
            activate FE
            FE -> BE: POST /api/posts (Post data)
            deactivate FE
            activate BE
            BE -> DB: Simpan data post dan URL
            deactivate BE
            activate DB

            alt Gagal simpan
                DB --> BE: Error response (e.g., constraint violation / connection failure)
                activate BE
                BE --> FE: 500 Error ("Failed to save post")
                deactivate BE
                activate FE
                FE -> Provider: Tampilkan pesan "Failed to save post"
                deactivate FE
            else Berhasil
                DB --> BE: Success (Post saved)
                deactivate DB
                activate BE

                BE --> FE: 201 Created ("Post saved")
                deactivate BE
                activate FE
                FE -> Provider: Tampilkan pesan "Post added successfully"
                deactivate FE
            end
        end
        end
    end
else Tidak ada gambar baru
    Provider -> FE: Isi form tanpa gambar baru
    activate FE
    FE -> BE: POST /api/posts (Post data)
    deactivate FE
    activate BE
    BE -> DB: Simpan data post tanpa URL
    deactivate BE
    activate DB

    alt Gagal simpan
        DB --> BE: Error response (e.g., constraint violation / connection failure)
        activate BE
        BE --> FE: 500 Error ("Failed to save post")
        deactivate BE
        activate FE
        FE -> Provider: Tampilkan pesan "Failed to save post"
        deactivate FE
    else Berhasil
        DB --> BE: Success (Post saved)
        deactivate DB
        activate BE
        BE --> FE: 201 Created ("Post saved")
        deactivate BE
        activate FE
        FE -> Provider: Tampilkan pesan "Post added successfully"
        deactivate FE
    end
end
deactivate FE


'== C. Pengeditan Post ==
Provider -> FE: Buka halaman detail post
activate FE
FE -> BE: GET /api/posts/{id}
activate BE
BE -> DB: Ambil data post
activate DB
DB --> BE: Return data
deactivate DB
BE --> FE: 200 OK (Post data)
deactivate BE
FE -> Provider: Tampilkan halaman detail post
deactivate FE


'== D. Edit dan Simpan Perubahan ==
group Mengedit Post
Provider -> FE: Klik "Edit Information"
activate FE
'Provider -> FE: Klik "Edit Information"
'activate FE
'FE -> BE: GET /api/tags
'activate BE
'BE -> Redis: GET cache:tags
'activate Redis
'
'alt Cache tersedia
'    Redis --> BE: Return cached tags
'else Cache kosong
'    Redis --> BE: Cache miss
'    deactivate Redis
'    BE -> DB: Mengambil semua data tag
'    activate DB
'    DB --> BE: Return tags data
'    deactivate DB
'    BE -> Redis: SET cache:tags (expired 1 jam)
'    activate Redis
'    Redis --> BE: OK
'    deactivate Redis
'end
'BE --> FE: 200 OK (Tags data)
'
'deactivate BE
'FE -> FE: Simpan tags di FE state
'activate FE #LightBlue
'deactivate FE #LightBlue
FE -> FE: Memasukkan data post kedalam form edit
activate FE #LightBlue
deactivate FE #LightBlue
FE -> FE: Ambil tags di FE state
activate FE #LightBlue
deactivate FE #LightBlue
FE -> Provider: Tampilkan form edit + data lama
deactivate FE


'== E. Menyimpan Perubahan ==


Provider -> FE: Submit form
activate FE
FE -> BE: PUT /api/posts/{id} (Post data)
deactivate FE
activate BE
BE -> DB: Update data post
deactivate BE
activate DB

alt Gagal update
    DB --> BE: Error response (e.g., constraint violation / connection failure)
    activate BE
    BE --> FE: 500 Internal Server Error ("Failed to update post")
    deactivate BE
    activate FE
FE -> Provider: Tampilkan pesan "Failed to update post"
    deactivate FE
else Berhasil update
    DB --> BE: Success (Post updated)
    deactivate DB
    activate BE
    BE --> FE: 200 OK (Post updated)
    deactivate BE
    activate FE
    FE -> Provider: Tampilkan pesan "Post updated successfully"
    deactivate FE
end
end
deactivate FE

@enduml
