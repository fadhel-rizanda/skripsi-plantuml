@startuml
' === Styling ===
skinparam sequence {
    LifelineFooterStrategy none
    MessageAlign center
    ArrowThickness 1
    ParticipantPadding 20
    GroupBorderThickness 0.5
    GroupBackgroundColor #F9F9F9
}
hide footbox

' === Participants ===
actor "Penyedia Hewan" as Provider
participant "Next.js FE (Pet Page)" as FE
participant "PetController (Laravel BE)" as BE
participant "AttachmentController" as FileBE
participant "Redis Cache" as Redis
participant "Cloud Storage (S3)" as Storage
database "Database" as DB


'== A. Membuka Form Tambah Hewan ==
Provider -> FE: Klik "Create Pet"
activate FE
FE -> BE: GET /api/tags
activate BE
BE -> Redis: GET cache:tags
activate Redis

alt Cache tersedia
    Redis --> BE: Return cached tags
else Cache kosong
    Redis --> BE: Cache miss
    deactivate Redis
    BE -> DB: Mengambil semua data tag
    activate DB
    DB --> BE: Return tags data
    deactivate DB
    BE -> Redis: SET cache:tags (expired 1 jam)
    activate Redis
    Redis --> BE: OK
    deactivate Redis
end
BE --> FE: 200 OK (Tags data)
deactivate BE
FE -> FE: Simpan tags di FE state
activate FE #LightBlue
deactivate FE #LightBlue

FE -> Provider: Tampilkan form input data + dropdown tag
deactivate FE


'== B. Penambahan Hewan ==
alt Ada file baru
Provider -> FE: Isi form dan mengunggah file baru
activate FE
    FE -> FileBE: GET /api/attachments/presigned-url
    deactivate FE
    activate FileBE

    alt Gagal generate URL
        FileBE --> FE: 500 Internal Server Error ("Failed to generate URL")
        activate FE
        FE -> Provider: Tampilkan pesan "Failed to generate upload URL"
        deactivate FE
    else URL berhasil digenerate
        FileBE --> FE: 200 OK (Pre-signed URL)
        deactivate FileBE
        activate FE

        FE -> Storage: POST file ke pre-signed URL
        deactivate FE
        activate Storage

        alt Gagal upload
            Storage --> FE: 500 Internal Server Error ("Upload failed")
            activate FE
            FE -> Provider: Tampilkan pesan "Failed to upload file"
            deactivate FE
        else Upload berhasil
            Storage --> FE: 201 Created (File uploaded)
            deactivate Storage
            activate FE
            FE -> BE: POST /api/pets (Pet data)
            deactivate FE
            activate BE
            BE -> DB: Simpan data hewan dan URL
            deactivate BE
            activate DB

            alt Gagal simpan
                DB --> BE: Error response (e.g., constraint violation / connection failure)
                activate BE
                BE --> FE: 500 Error ("Failed to save pet")
                deactivate BE
                activate FE
                FE -> Provider: Tampilkan pesan "Failed to save pet"
                deactivate FE
            else Berhasil
                DB --> BE: Success (Pet saved)
                deactivate DB
                activate BE

                BE --> FE: 201 Created ("Pet saved")
                deactivate BE
                activate FE
                FE -> Provider: Tampilkan pesan "Pet added successfully"
                deactivate FE
            end
        end
    end
else Tidak ada file baru
    Provider -> FE: Isi form tanpa file baru
    activate FE
    FE -> BE: POST /api/pets (Pet data)
    deactivate FE
    activate BE
    BE -> DB: Simpan data hewan tanpa URL
    deactivate BE
    activate DB

    alt Gagal simpan
        DB --> BE: Error response (e.g., constraint violation / connection failure)
        activate BE
        BE --> FE: 500 Error ("Failed to save pet")
        deactivate BE
        activate FE
        FE -> Provider: Tampilkan pesan "Failed to save pet"
        deactivate FE
    else Berhasil
        DB --> BE: Success (Pet saved)
        deactivate DB
        activate BE
        BE --> FE: 201 Created ("Pet saved")
        deactivate BE
        activate FE
        FE -> Provider: Tampilkan pesan "Pet added successfully"
        deactivate FE
    end
end
deactivate FE


'== C. Pengeditan Hewan ==
Provider -> FE: Buka halaman detail hewan
activate FE
FE -> BE: GET /api/pets/{id}
activate BE
BE -> DB: Ambil data hewan
activate DB
DB --> BE: Return data
deactivate DB
BE --> FE: 200 OK (Pet data)
deactivate BE
FE -> Provider: Tampilkan halaman detail hewan
deactivate FE


'== D. Edit dan Simpan Perubahan ==
alt Mengedit informasi hewan
Provider -> FE: Klik "Edit Information"
activate FE
FE -> FE: Memasukkan data baru hewan kedalam form edit
activate FE #LightBlue
deactivate FE #LightBlue
FE -> Provider: Tampilkan form edit + data lama
deactivate FE


'== E. Menyimpan Perubahan ==
    Provider -> FE: Submit form edit
    activate FE
    FE -> BE: PUT /api/pets/{id} (Pet data)
    deactivate FE
    activate BE
    BE -> DB: Update data hewan
    deactivate BE
    activate DB

    alt Gagal update
        DB --> BE: Error response (e.g., constraint violation / connection failure)
        activate BE
        BE --> FE: 500 Internal Server Error ("Failed to update pet")
        deactivate BE
        activate FE
        FE -> Provider: Tampilkan pesan "Failed to update pet"
        deactivate FE
    else Berhasil update
        DB --> BE: Success (Pet updated)
        deactivate DB
        activate BE
        BE --> FE: 200 OK (Pet updated)
        deactivate BE
        activate FE
        FE -> Provider: Tampilkan pesan "Pet updated successfully"
        deactivate FE
    end
    else Tidak mengedit informasi hewan
                Provider -> FE: Klik tombol "Takedown"
                activate FE
                FE -> Provider: Tampilkan pop-up konfirmasi
                deactivate FE

                alt Konfirmasi "Continue"
                    Provider -> FE: Klik "Continue"
                    activate FE
                    FE -> BE: DELETE /api/pets/{id}
                    deactivate FE
                    activate BE
                    BE -> DB: Hapus data hewan berdasarkan ID
                    deactivate BE
                    activate DB

                    alt Penghapusan berhasil
                        DB --> BE: Success (Row deleted)
                        activate BE
                        BE --> FE: 200 OK ("Pet deleted successfully")
                        deactivate BE
                        activate FE
                        FE -> FE: Redirect ke halaman daftar hewan
                        activate FE #LightBlue
                        deactivate FE #LightBlue
                        FE -> Provider: Tampilkan pesan "Pet deleted successfully"
                        deactivate FE

                    else Gagal menghapus data
                        DB --> BE: Error (e.g., data not found / connection failure)
                        deactivate DB
                        activate BE
                        BE --> FE: 500 Internal Server Error ("Failed to delete pet")
                        deactivate BE
                        activate FE
                        FE -> Provider: Tampilkan pesan "Failed to delete pet. Please try again."
                        deactivate FE
                    end

                else Membatalkan konfirmasi
                    Provider -> FE: Klik "Cancel"
                    activate FE
                    FE -> Provider: Tutup pop-up tanpa aksi
                    deactivate FE
                end
    end

@enduml
