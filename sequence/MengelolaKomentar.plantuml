@startuml
' === Styling ===
skinparam sequence {
    LifelineFooterStrategy none
    MessageAlign center
    ArrowThickness 1
    ParticipantPadding 20
    GroupBorderThickness 0.5
    GroupBackgroundColor #F9F9F9
}
hide footbox


' === Participants ===
actor Pengguna
participant "Post Detail Page (Next.js FE)" as FE
participant "CommentController (Laravel BE)" as BE
database "Database (PostgreSQL)" as DB
participant "NotificationService (Laravel BE)" as NS
actor "Pengguna (pemilik post / parent comment)" as FE_Adopter

' === Normal Flow: Membuka Halaman Komentar ===
Pengguna -> FE: Buka halaman detail postingan
activate FE
FE -> BE: GET /api/posts/{post_id}/comments
deactivate FE
activate BE
BE -> DB: Mengambil semua komentar berdasarkan post_id
activate DB
DB --> BE: Return list of comments
deactivate DB
BE --> FE: 200 OK (Comments list)
deactivate BE
activate FE
FE -> Pengguna: Tampilkan daftar komentar
deactivate FE


' === Flow 3: Menambah Komentar Baru ===
Pengguna -> FE: Ketik komentar dan klik "Send"
activate FE
FE -> BE: POST /api/comments (body: {post_id, content})
deactivate FE
activate BE
BE -> DB: Menyimpan data komentar dengan post_id
deactivate BE
activate DB
alt Gagal insert ke DB
    DB --> BE: Error (e.g., constraint violation / connection failure)
    activate BE
    BE --> FE: 400 Bad Request / 500 Internal Server Error ("Failed to post comment")
    deactivate BE
    activate FE
    FE -> Pengguna: Tampilkan pesan "Failed to post comment"
    deactivate FE
else Berhasil insert ke DB
    DB --> BE: Success (Comment saved)
    deactivate DB
    activate BE

    BE -> NS: Broadcast event "MessageSent" ke channel "notification.{user_id}
    activate NS
    NS -> FE_Adopter: Push notification "New comment on your post"
    NS --> BE: Event broadcasted

    deactivate NS

    BE --> FE: 201 Created ("Comment added")
    deactivate BE
    activate FE
    FE -> Pengguna: Tambahkan komentar baru ke daftar
    deactivate FE
end


' === Flow 4: Membalas Komentar ===
Pengguna -> FE: Klik "Reply" dan kirim balasan
activate FE
FE -> BE: POST /api/comments (body: {post_id, parent_id, content})
deactivate FE
activate BE
BE -> DB: Menyimpan data komentar dengan post_id dan parent_id
deactivate BE
activate DB
alt Gagal insert ke DB
    DB --> BE: Error (e.g., constraint violation / connection failure)
    activate BE

    BE --> FE: 400 Bad Request / 500 Internal Server Error ("Failed to post reply")
    deactivate BE
    activate FE
    FE -> Pengguna: Tampilkan pesan "Failed to post reply"
    deactivate FE
else Berhasil insert ke DB
    DB --> BE: Success (Reply saved)
    deactivate DB
    activate BE

    BE -> NS: Broadcast event "MessageSent" ke channel "notification.{user_id}
    activate NS
    NS -> FE_Adopter: Push notification "New reply on your comment"
    NS --> BE: Event broadcasted
    deactivate NS

    BE --> FE: 201 Created ("Reply added")
    deactivate BE
    activate FE
    FE -> Pengguna: Tampilkan balasan di bawah komentar induk
    deactivate FE
end


' === Flow 5: Mengedit Komentar ===
Pengguna -> FE: Klik ikon pensil, ubah teks, lalu klik "Save"
activate FE
FE -> BE: PUT /api/comments/{comment_id} (body: {content})
deactivate FE
activate BE
BE -> DB: Memperbarui komentar
deactivate BE
activate DB
alt Gagal update ke DB
    DB --> BE: Error (e.g., constraint violation / data not found / connection failure)
    activate BE
    BE --> FE: 400 Bad Request / 500 Internal Server Error ("Failed to update comment")
    deactivate BE
    activate FE
    FE -> Pengguna: Tampilkan pesan "Failed to update comment"
    deactivate FE
else Berhasil update
    DB --> BE: Success (Comment updated)
    deactivate DB
    activate BE
    BE --> FE: 200 OK ("Comment updated")
    deactivate BE
    activate FE
    FE -> Pengguna: Perbarui tampilan komentar
    deactivate FE
end


' === Flow 6: Menghapus Komentar ===
Pengguna -> FE: Klik ikon tempat sampah dan konfirmasi hapus
activate FE
FE -> BE: DELETE /api/comments/{comment_id}
deactivate FE
activate BE
BE -> DB: Menghapus komentar
deactivate BE
activate DB
alt Gagal delete dari DB
    DB --> BE: Error (e.g., constraint violation / data not found / connection failure)
    activate BE
    BE --> FE: 500 Internal Server Error ("Failed to delete comment")
    deactivate BE
    activate FE
    FE -> Pengguna: Tampilkan pesan "Failed to delete comment"
    deactivate FE
else Berhasil delete
    DB --> BE: Success (Comment deleted)
    deactivate DB
    activate BE
    BE --> FE: 200 OK ("Comment deleted")
    deactivate BE
    activate FE
    FE -> Pengguna: Hapus komentar dari daftar
    deactivate FE
end

@enduml
