@startuml
' === Styling ===
skinparam sequence {
    LifelineFooterStrategy none
    MessageAlign center
    ArrowThickness 1
    ParticipantPadding 20
    GroupBorderThickness 0.5
    GroupBackgroundColor #F9F9F9
}
hide footbox

' === Participants ===
actor Admin
participant "Adoption Process Page (Next.js FE)" as FE
participant "AdoptionProcessController (Laravel BE)" as BE
database "PostgreSQL (DB)" as DB
participant "NotificationService (Laravel BE)" as NS
actor "Pengguna (Calon Pengadopsi & Penyedia Hewan)" as FE_Adopter

' === Akses Data Proses Adopsi ===
    alt Flow A: Dari Daftar Proses Adopsi
        Admin -> FE: Klik menu "Adoption Process" pada navbar
        activate FE
        FE -> BE: GET /api/adoptions
        activate BE
        BE -> DB: Ambil daftar seluruh proses adopsi
        activate DB
        DB --> BE: Return list of adoption processes
        deactivate DB
        BE --> FE: 200 OK (Daftar proses adopsi)
        deactivate BE
        FE -> Admin: Tampilkan tabel daftar proses adopsi dengan status terkini
        deactivate FE

    else Flow B: Dari Halaman Detail (Hand Over Day)
        Admin -> FE: Buka halaman detail proses adopsi
        activate FE
        FE -> BE: GET /api/adoptions/{id}
        activate BE
        BE -> DB: Ambil detail proses adopsi berdasarkan ID
        activate DB
        DB --> BE: Return adoption process details
        deactivate DB
        BE --> FE: 200 OK (Adoption process details)
        deactivate BE
        FE -> Admin: Tampilkan halaman detail dengan tombol "Complete Adoption"
        deactivate FE
    end

' === Proses Finalisasi (Sama untuk Flow A & B) ===
    alt Flow A: Klik tombol "Approve"
        Admin -> FE: Klik tombol "Approve" pada kolom Action
        activate FE
    else Flow B: Klik tombol "Complete Adoption"
        Admin -> FE: Klik tombol "Complete Adoption" pada bagian "Hand Over Day"
    end

    activate FE

    ' === Validasi di frontend ===
    FE -> FE: Validasi status proses (siap untuk finalisasi)
    activate FE #LightBlue
    deactivate FE #LightBlue

    FE -> Admin: Tampilkan pop-up konfirmasi finalisasi proses adopsi
    deactivate FE

    alt Admin konfirmasi "Continue"
        Admin -> FE: Klik "Continue"
        activate FE
        FE -> BE: PUT /api/adoptions/{id}/finalize
        activate BE
        BE -> DB: Update status proses adopsi menjadi "Completed"
        activate DB

        alt Finalisasi berhasil
            DB --> BE: OK (Status updated)

            FE -> Admin: Tampilkan pesan "Adoption process finalized successfully"
            deactivate FE

            ' === Kirim notifikasi ke pihak terkait ===
            BE -> NS: Broadcast event "MessageSent" ke channel "notification.{user_id}
            activate NS
            NS -> FE_Adopter: Push notification "Congratulations! Your adoption has been completed"
            deactivate NS
            BE --> FE: 200 OK ("Adoption process finalized successfully")
            deactivate BE

        else Gagal memperbarui status
            DB --> BE: Error (Update failed)
            deactivate DB
            activate BE
            BE --> FE: 500 Internal Server Error ("Failed to finalize adoption process")
            deactivate BE
            activate FE
            FE -> Admin: Tampilkan pesan "Failed to finalized adoption process. Please try again"
            deactivate FE
        end

    else Admin membatalkan konfirmasi
        Admin -> FE: Klik "Cancel"
        activate FE
        FE -> Admin: Tutup pop-up, proses adopsi tetap tersimpan
        deactivate FE
    end

@enduml