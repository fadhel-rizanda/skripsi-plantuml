@startuml
' === Styling ===
skinparam sequence {
    LifelineFooterStrategy none
    MessageAlign center
    ArrowThickness 1
    ParticipantPadding 20
    GroupBorderThickness 0.5
    GroupBackgroundColor #F9F9F9
}
hide footbox

' === Participants ===
actor "Penyedia Hewan" as Provider
participant "Next.js FE (Pet Page)" as FE
participant "Laravel BE (PetController)" as BE
participant "FileUploadController" as FileBE
participant "Redis Cache" as Redis
participant "Cloud Storage (S3)" as Storage
database "Database" as DB


'== A. Membuka Form Tambah Hewan ==
Provider -> FE: Klik "Create Pet"
activate FE
FE -> BE: GET /api/tags
activate BE
BE -> Redis: GET cache:tags
activate Redis

alt Cache tersedia
    Redis --> BE: Return cached tags
else Cache kosong
    Redis --> BE: Cache miss
    deactivate Redis
    BE -> DB: Mengambil semua data tag
    activate DB
    DB --> BE: Return tags data
    deactivate DB
    BE -> Redis: SET cache:tags (expired 1 jam)
    activate Redis
    Redis --> BE: OK
    deactivate Redis
end
BE --> FE: 200 OK (Tags data)
deactivate BE
FE -> FE: Simpan tags di FE state
activate FE #LightBlue
deactivate FE #LightBlue

FE -> Provider: Tampilkan form input data + dropdown tag
deactivate FE


'== B. Penambahan Hewan ==
alt Ada file baru
Provider -> FE: Isi form dan mengunggah file baru
activate FE
    FE -> FileBE: GET /api/file-upload/presigned-url
    deactivate FE
    activate FileBE

    alt Gagal generate URL
        FileBE --> FE: 500 Internal Server Error ("Failed to generate URL")
        activate FE
        FE -> Provider: Tampilkan pesan gagal upload
        deactivate FE
    else URL berhasil digenerate
        FileBE --> FE: 200 OK (Pre-signed URL)
        deactivate FileBE
        activate FE

        FE -> Storage: POST file ke pre-signed URL
        deactivate FE
        activate Storage

        alt Gagal upload
            Storage --> FE: 500 Internal Server Error ("Upload failed")
            activate FE
            FE -> Provider: Tampilkan pesan gagal upload
            deactivate FE
        else Upload berhasil
            Storage --> FE: 201 Created (File uploaded)
            deactivate Storage
            activate FE
            FE -> BE: POST /api/pets (Pet data)
            deactivate FE
            activate BE
            BE -> DB: Simpan data hewan dan URL
            deactivate BE
            activate DB

            alt Gagal simpan
                DB --> BE: Error response (e.g., constraint violation / connection failure)
                activate BE
                BE --> FE: 500 Error ("Failed to save pet")
                deactivate BE
                activate FE
                FE -> Provider: Tampilkan pesan gagal simpan
                deactivate FE
            else Berhasil
                DB --> BE: Success (Pet saved)
                deactivate DB
                activate BE

                BE --> FE: 201 Created ("Pet saved")
                deactivate BE
                activate FE
                FE -> Provider: Notifikasi "Pet added successfully"
                deactivate FE
            end
        end
    end
else Tidak ada file baru
    Provider -> FE: Isi form tanpa file baru
    activate FE
    FE -> BE: POST /api/pets (Pet data)
    deactivate FE
    activate BE
    BE -> DB: Simpan data hewan tanpa URL
    deactivate BE
    activate DB

    alt Gagal simpan
        DB --> BE: Error response (e.g., constraint violation / connection failure)
        activate BE
        BE --> FE: 500 Error ("Failed to save pet")
        deactivate BE
        activate FE
        FE -> Provider: Pesan gagal simpan
        deactivate FE
    else Berhasil
        DB --> BE: Success (Pet saved)
        deactivate DB
        activate BE
        BE --> FE: 201 Created ("Pet saved")
        deactivate BE
        activate FE
        FE -> Provider: Notifikasi "Pet added successfully"
        deactivate FE
    end
end
deactivate FE


'== C. Pengeditan Hewan ==
Provider -> FE: Buka halaman detail hewan
activate FE
FE -> BE: GET /api/pets/{id}
activate BE
BE -> DB: Ambil data hewan
activate DB
DB --> BE: Return data
deactivate DB
BE --> FE: 200 OK (Pet data)
deactivate BE
FE -> Provider: Tampilkan halaman detail hewan
deactivate FE


'== D. Edit dan Simpan Perubahan ==
Provider -> FE: Klik "Edit Information"
activate FE
'Provider -> FE: Klik "Edit Information"
'activate FE
'FE -> BE: GET /api/tags
'activate BE
'BE -> Redis: GET cache:tags
'activate Redis
'
'alt Cache tersedia
'    Redis --> BE: Return cached tags
'else Cache kosong
'    Redis --> BE: Cache miss
'    deactivate Redis
'    BE -> DB: Mengambil semua data tag
'    activate DB
'    DB --> BE: Return tags data
'    deactivate DB
'    BE -> Redis: SET cache:tags (expired 1 jam)
'    activate Redis
'    Redis --> BE: OK
'    deactivate Redis
'end
'BE --> FE: 200 OK (Tags data)

'deactivate BE
'FE -> FE: Simpan tags di FE state
FE -> FE: Memasukkan data hewan kedalam form edit
activate FE #LightBlue
deactivate FE #LightBlue
FE -> FE: Ambil tags di FE state
activate FE #LightBlue
deactivate FE #LightBlue
FE -> Provider: Tampilkan form edit + data lama
deactivate FE


'== E. Menyimpan Perubahan ==


alt Ada file baru
    Provider -> FE: Submit form edit dan file baru
    activate FE
    FE -> FileBE: GET /api/file-upload/presigned-url
    deactivate FE
    activate FileBE

    alt Gagal generate URL
        FileBE --> FE: 500 Internal Server Error ("Failed to generate URL")
        activate FE
        FE -> Provider: Tampilkan pesan gagal upload
        deactivate FE
    else URL berhasil
        FileBE --> FE: 200 OK (Pre-signed URL)
        deactivate FileBE
        activate FE
        FE -> Storage: POST file ke pre-signed URL
        deactivate FE
        activate Storage

        alt Upload gagal
            Storage --> FE: 500 Internal Server Error ("Upload failed")
            activate FE
            FE -> Provider: Pesan gagal upload
            deactivate FE
        else Upload berhasil
            Storage --> FE: Success
            deactivate Storage
            activate FE
            FE -> BE: PUT /api/pets/{id} (Pet data)
            deactivate FE
            activate BE
            BE -> DB: Update data hewan
            deactivate BE
            activate DB

            alt Gagal update
                DB --> BE: Error response (e.g., constraint violation / connection failure)
                activate BE
                BE --> FE: 500 Internal Server Error ("Failed to update pet")
                deactivate BE
                activate FE
                FE -> Provider: Pesan gagal update
                deactivate FE
            else Berhasil update
                DB --> BE: Success (Pet updated)
                deactivate DB
                activate BE
                BE --> FE: 200 OK (Pet updated)
                deactivate BE
                activate FE
                FE -> Provider: Notifikasi "Pet updated successfully"
                deactivate FE
            end
        end
    end
else Tidak ada file baru
    Provider -> FE: Submit form edit tanpa file baru
    activate FE
    FE -> BE: PUT /api/pets/{id} (Pet data)
    deactivate FE
    activate BE
    BE -> DB: Update data hewan
    deactivate BE
    activate DB

    alt Gagal update
        DB --> BE: Error response (e.g., constraint violation / connection failure)
        activate BE
        BE --> FE: 500 Internal Server Error ("Failed to update pet")
        deactivate BE
        activate FE
        FE -> Provider: Pesan gagal update
        deactivate FE
    else Berhasil update
        DB --> BE: Success (Pet updated)
        deactivate DB
        activate BE
        BE --> FE: 200 OK (Pet updated)
        deactivate BE
        activate FE
        FE -> Provider: Notifikasi "Pet updated successfully"
        deactivate FE
    end
end
deactivate FE

@enduml
